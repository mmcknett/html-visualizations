<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geostrophic Approximation Visualization</title>
</head>
<body>
  <header>This page visualizes the Geostrophic Approximation in atmospheric dynamics</header>
  <section>
    <article>
      <p>The Geostrophic Approximation is where we get the explanation that "wind flows parallel to isobars" on a surface prognostic chart.</p>        
      <p>This visualization is based on the explanation and derivation from <a href="https://cpb-us-w2.wpmucdn.com/sites.uwm.edu/dist/8/663/files/2019/05/Oct2.pdf">Synoptic Meteorology I: The Geostrophic Approximation</a>.
    </article>
  </section>
  <section>
    <button type="button" id="startstop">Start</button>
    <button type="button" id="reset_button">Reset</button>
  </section>
  <section>
    <noscript>You'll need JavaScript enabled to see the visualization move.</noscript>
    <!-- Diagram starts here -->
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="-100 0 200 150" fill="transparent"
      width="95vw" height="70vh"
    >
      <defs>
        <style>@import url('https://fonts.googleapis.com/css2?family=Caveat+Brush&amp;family=Source+Code+Pro&amp;family=Source+Sans+Pro&amp;family=Crimson+Pro&amp;display=block');</style>
      </defs>
      <g>
        <path d="M-100,33 L100,33" stroke="#ef1d1d" stroke-width="1"/>
        <path d="M-100,67 L100,67" stroke="#dc1d4e" stroke-width="1"/>
        <path d="M-100,100 L100,100" stroke="#881d88" stroke-width="1"/>
        <path d="M-100,133 L100,133" stroke="#1d1def" stroke-width="1"/>
      </g>
      <g id="freebody_system" transform="translate(0, 120)">
        <g id="parcel">
          <rect x="-1" y="-1" width="2" height="2" fill="blue" stroke="#9999FF" stroke-width="0.25" />
        </g>
        <g id="pressure_gradient" transform="translate(0, -12)">
          <g id="pressure_pointer">
            <path
              d="M0,10 L0,0"
              fill="#1d1d1d" stroke="#1d1d1d"
              stroke-width="1" stroke-linecap="round" stroke-linejoin="round" />
            <path
              d="M-1,2 L0,0 L1,2"
              fill="none" stroke="#1d1d1d"
              stroke-width="1" stroke-linecap="round" stroke-linejoin="round" />
          </g>
          <g font-size="5" font-family="Caveat Brush" text-align="left" fill="#1d1d1d" transform-origin="top left"
            transform="translate(2, 0)">
            <text>Pressure Gradient</text>
          </g>
        </g>
        <g id="velocity_vector">
          <g id="velocity_pointer" transform="scale(0)">
            <path
              d="M0,0 L0,-10"
              stroke="#2222EE"
              stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round" />
            <path
              d="M-1,-8 L0,-10 L1,-8"
              stroke="#2222EE"
              stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round" />
          </g>
          <g font-size="3" font-family="Caveat Brush" text-align="left" fill="#1d1d88" transform-origin="top left"
            transform="translate(2, -5)">
            <text>Velocity</text>
          </g>
        </g>
      </g>
    </svg>
    <!-- Simulation Code here -->
    <script lang="javascript">
      // Simulation management
      let simIntervalId = null;
      let isRunning = () => simIntervalId != null;

      const startstopbutton = document.getElementById("startstop");
      startstopbutton.addEventListener('click', (ev) => {
        if (isRunning()) {
          stop();
        } else {
          start();
        }
      });

      const resetbutton = document.getElementById("reset_button");
      resetbutton.addEventListener('click', (ev) => {
        stop();
        reset();
      })

      function start() {
        simIntervalId = setInterval(() => {
          simStep(1);
        }, 16.67); // 60 frames per second
        startstopbutton.innerText = "Stop";
      }

      function stop() {
        clearInterval(simIntervalId);
        simIntervalId = null;
        startstopbutton.innerText = "Start";
      }

      // Simulation logic

      const INITIAL_Y = 120;
      let x = 0;
      let y = INITIAL_Y;
      let v_x = 0;
      let v_y = 0;

      const PRESSURE_GRADIENT = -0.01;

      function reset() {
        x = 0;
        y = INITIAL_Y;
        v_x = 0;
        v_y = 0;
        renderSystem();
      }

      function simStep(timestep) {
        dvy = PRESSURE_GRADIENT * timestep;
        v_y += dvy;
        
        dy = v_y * timestep;
        y += dy;

        if (y < 10) {
          y = INITIAL_Y;
        }
        renderSystem();
      }

      function renderSystem() {
        let system = document.getElementById("freebody_system");
        system.setAttribute('transform', `translate(${x}, ${y})`);
        console.log('Moving to', x, y);

        let vel_vector = document.getElementById("velocity_pointer");
        vel_vector.setAttribute('transform', `scale(${-v_y})`);
      }
    </script>
  </section>
</body>
</html>